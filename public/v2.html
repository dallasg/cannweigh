<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deli Vault Weighing ‚Äì React + Tailwind</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN for quick start) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: '#0f1115',
            panel: '#141823',
            line: '#1f2331'
          },
          boxShadow: {
            panel: '0 10px 30px rgba(0,0,0,.35)'
          },
          borderRadius: {
            xl2: '14px'
          }
        }
      }
    }
  </script>
  <!-- React 18 UMD + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[linear-gradient(180deg,#0e1014,#10131a_40%,#0e1116)] text-zinc-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    // ---------- Storage Keys ----------
    const KEY_REGISTRY = 'dv_registry_v1';
    const KEY_LOG = 'dv_log_v1';
    const KEY_SETTINGS = 'dv_settings_v1';

    // ---------- Utils ----------
    const todayStr = () => {
      const d = new Date();
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    const round2 = n => Math.round(n * 100) / 100;
    const fmt2 = n => (n === null || n === undefined || Number.isNaN(n)) ? '' : Number(n).toFixed(2);
    const downloadCSV = (rows, filename) => {
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell ?? '');
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    };

    // ---------- Simple Toast ----------
    function useToast(){
      const [msg, setMsg] = useState('');
      useEffect(() => {
        if(!msg) return;
        const t = setTimeout(() => setMsg(''), 2200);
        return () => clearTimeout(t);
      }, [msg]);
      return [msg, setMsg];
    }

    // ---------- App ----------
    function App(){
      // State
      const [registry, setRegistry] = useState(() => JSON.parse(localStorage.getItem(KEY_REGISTRY) || '{}'));
      const [log, setLog] = useState(() => JSON.parse(localStorage.getItem(KEY_LOG) || '[]'));
      const [settings, setSettings] = useState(() => {
        const defaults = { varianceThreshold: 5, storeName: '' };
        try { return { ...defaults, ...(JSON.parse(localStorage.getItem(KEY_SETTINGS) || '{}')) }; }
        catch { return defaults; }
      });

      const [employee, setEmployee] = useState('');
      const [session, setSession] = useState('AM');
      const [date, setDate] = useState(todayStr());

      const [scanId, setScanId] = useState('');
      const [vault, setVault] = useState('BIG');
      const [gross, setGross] = useState('');
      const [notes, setNotes] = useState('');

      const [msg, toast] = useToast();
      const scanRef = useRef(null);

      // Derived
      const tare = useMemo(() => {
        const rec = registry[scanId?.trim()];
        return rec ? Number(rec.tare || 0) : NaN;
      }, [scanId, registry]);

      const net = useMemo(() => {
        const g = parseFloat(gross), t = parseFloat(tare);
        if (isFinite(g) && isFinite(t)) return Math.max(0, g - t);
        return NaN;
      }, [gross, tare]);

      const variance = useMemo(() => {
        if (!scanId || !isFinite(net)) return null;
        const rows = log
          .filter(e => e.productId === scanId && e.vault === vault)
          .sort((a,b) => a.ts - b.ts);
        if (!rows.length) return 0;
        return net - rows[rows.length - 1].net;
      }, [log, scanId, vault, net]);

      const todayRows = useMemo(() => log.filter(e => e.date === date).sort((a,b) => a.ts - b.ts), [log, date]);
      const flagged = useMemo(() => todayRows.filter(e => Math.abs(e.variance ?? 0) >= Number(settings.varianceThreshold || 5)).length, [todayRows, settings]);

      // Effects: persist
      useEffect(() => localStorage.setItem(KEY_REGISTRY, JSON.stringify(registry)), [registry]);
      useEffect(() => localStorage.setItem(KEY_LOG, JSON.stringify(log)), [log]);
      useEffect(() => localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)), [settings]);

      // Keyboard: "/" focus scanner
      useEffect(() => {
        const handler = (e) => {
          if (e.key === '/' && !e.metaKey && !e.ctrlKey) {
            e.preventDefault(); scanRef.current?.focus(); scanRef.current?.select();
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, []);

      // Handlers
      const addEntry = () => {
        const id = (scanId || '').trim();
        const rec = registry[id];
        const g = parseFloat(gross);
        const t = parseFloat(tare);
        const n = parseFloat(net);

        if (!id) return toast('Scan or enter a Product ID first.');
        if (!rec) return toast('Unknown Product ID. Add it in the registry with a tare.');
        if (!isFinite(g)) return toast('Enter the gross weight (g).');
        if (!isFinite(t)) return toast('Tare missing ‚Äî check registry.');
        if (!isFinite(n)) return toast('Net calculation failed.');

        const v = variance ?? 0;
        const entry = {
          ts: Date.now(),
          date, employee: employee.trim(),
          session, vault,
          productId: id,
          name: rec.name || '',
          tare: round2(t),
          gross: round2(g),
          net: round2(n),
          variance: round2(v),
          notes: (notes || '').trim()
        };
        setLog(prev => [...prev, entry]);
        setGross(''); setNotes('');
        toast('Entry added.');
        // keep scanId for rapid multi-weights if desired
      };

      const clearToday = () => {
        if (!confirm(`Clear entries for ${date}? History (other days) is kept.`)) return;
        setLog(prev => prev.filter(e => e.date !== date));
        toast('Today cleared.');
      };

      const exportLog = () => {
        const rows = [['timestamp_iso','date','time','employee','session','vault','product_id','name','tare_g','gross_g','net_g','variance_g','notes']];
        for (const e of log){
          const dt = new Date(e.ts);
          const iso = dt.toISOString();
          const time = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
          rows.push([iso, e.date, time, e.employee, e.session, e.vault, e.productId, e.name || '', fmt2(e.tare), fmt2(e.gross), fmt2(e.net), fmt2(e.variance), (e.notes||'').replace(/\n/g,' ')]);
        }
        downloadCSV(rows, `deli_log_${todayStr()}.csv`);
      };

      const exportRegistry = () => {
        const rows = [['product_id','name','tare_g']];
        Object.entries(registry).forEach(([id, r]) => rows.push([id, r.name || '', String(r.tare ?? '')]));
        downloadCSV(rows, `registry_${todayStr()}.csv`);
      };

      const finalize = () => {
        const count = log.filter(e => e.date === date && e.session === session).length;
        alert(`Session ${session} on ${date} finalized.\nEntries: ${count}\n\nReminders:\n‚Ä¢ PM: Move small vaults BOH\n‚Ä¢ Ensure all regulated product is in Fulfillment`);
      };

      // Registry helpers
      const saveProduct = (id, name, tare) => {
        if (!id) return toast('Enter a Product ID.');
        const t = parseFloat(tare);
        if (!isFinite(t)) return toast('Enter a valid tare (g).');
        setRegistry(prev => ({ ...prev, [id]: { name: (name||''), tare: round2(t) } }));
        if (scanId.trim() === id) toast('Product saved. Tare applied.');
        else toast('Product saved.');
      };
      const deleteProduct = (id) => {
        if (!id) return toast('Enter a Product ID to delete.');
        if (!registry[id]) return toast('Product ID not found.');
        if (!confirm(`Delete Product ID ‚Äú${id}‚Äù?`)) return;
        const copy = { ...registry }; delete copy[id]; setRegistry(copy);
        toast('Product removed.');
      };
      const loadDemo = () => {
        const demo = {
          "GLW-FOH": { name: "Gluwberry FOH Vault", tare: 345.80 },
          "GLW-BOH": { name: "Gluwberry Big Vault", tare: 1287.30 },
          "ZKZ-FOH": { name: "ZkittleZ FOH Vault", tare: 351.20 },
          "GSC-BOH": { name: "GSC Big Vault", tare: 1279.50 }
        };
        setRegistry(prev => ({ ...demo, ...prev }));
        toast('Demo products loaded.');
      };

      return (
        <div className="max-w-6xl mx-auto p-4 pb-14">
          {/* Header */}
          <div className="sticky top-0 z-10 backdrop-blur bg-black/40 border-b border-line">
            <div className="flex items-center gap-3 py-3">
              <div className="w-9 h-9 rounded-xl shadow-panel" style={{background:'radial-gradient(120% 120% at 20% 20%, #79b8ff 0, #5ee1a1 42%, #7a5cff 80%)'}} />
              <div>
                <h1 className="text-base font-semibold tracking-wide">Deli Vault Weighing</h1>
                <p className="text-xs text-zinc-400">Scan ‚Üí Weigh ‚Üí Log. AM/PM sessions. CSV export.</p>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <span className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-line bg-slate-800/70 text-xs">
                  Variance threshold: <b className="font-semibold">{Number(settings.varianceThreshold||5)} g</b>
                </span>
                <Settings settings={settings} setSettings={setSettings} />
              </div>
            </div>
          </div>

          {/* Session Card */}
          <Panel title="Session details">
            <div className="grid md:grid-cols-3 gap-3">
              <Input label="Employee" value={employee} onChange={setEmployee} placeholder="Your name" />
              <Select label="Session" value={session} onChange={setSession} options={[['AM','Morning (AM)'], ['PM','Evening (PM)']]} />
              <Input type="date" label="Date" value={date} onChange={setDate} />
            </div>
            <p className="text-xs text-zinc-400 mt-2">Tip: press <b>/</b> to jump to the scanner input.</p>
            <div className="grid sm:grid-cols-3 gap-3 mt-4">
              <KPI label="Entries today" value={todayRows.length} />
              <KPI label="Flagged variances" value={flagged} />
              <KPI label="Products in registry" value={Object.keys(registry).length} />
            </div>
          </Panel>

          {/* Scan & Registry */}
          <div className="grid lg:grid-cols-2 gap-4 mt-4">
            <Panel title="Scan vault & weigh">
              <div className="grid md:grid-cols-3 gap-3">
                <Input refEl={scanRef} label="Scan / Enter Product ID" value={scanId} onChange={setScanId} placeholder="Scan barcode or type Product ID" />
                <Select label="Vault" value={vault} onChange={setVault} options={[['BIG','Big (BOH)'], ['SMALL','Small (FOH)']]} />
                <Input type="number" step="0.01" label="Gross weight (g)" value={gross} onChange={setGross} placeholder="e.g. 487.32" />
              </div>
              <div className="grid md:grid-cols-3 gap-3 mt-3">
                <Input disabled label="Tare (auto)" value={isFinite(tare) ? fmt2(tare) : ''} onChange={() => {}} />
                <Input disabled label="Net product (g)" value={isFinite(net) ? fmt2(net) : ''} onChange={() => {}} />
                <Input disabled label="Variance vs last (g)" value={variance === null ? '' : fmt2(variance)} onChange={() => {}} />
              </div>
              <div className="grid md:grid-cols-3 gap-3 mt-3 items-end">
                <Input label="Notes (optional)" value={notes} onChange={setNotes} placeholder="e.g. Refilled FOH 1 oz" />
                <div className="flex gap-2">
                  <button onClick={addEntry} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold shadow-panel">‚ûï Add entry</button>
                  <button onClick={() => { setScanId(''); setGross(''); setNotes(''); }} className="px-4 py-2 rounded-lg border border-line">Clear</button>
                </div>
              </div>
              <p className="text-xs text-zinc-400 mt-2">Scales: enter the gross from the display. (You can add Web Serial/HID later for auto-fill.)</p>
            </Panel>

            <RegistryPanel
              registry={registry}
              saveProduct={saveProduct}
              deleteProduct={deleteProduct}
              loadDemo={loadDemo}
              exportRegistry={exportRegistry}
              prefillId={scanId}
            />
          </div>

          {/* Log Table */}
          <Panel className="mt-4" title="Log entries">
            <div className="flex items-center gap-2">
              <span className={`px-2.5 py-1 rounded-full text-xs border ${session==='AM' ? 'bg-blue-950/60 border-blue-900 text-blue-300' : 'bg-green-950/60 border-green-900 text-green-300'}`}>{session}</span>
              <div className="ml-auto flex gap-2">
                <button onClick={finalize} className="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 font-semibold shadow-panel">‚úÖ Finalize session</button>
                <button onClick={exportLog} className="px-3 py-2 rounded-lg border border-line">‚¨áÔ∏è Export log CSV</button>
                <button onClick={clearToday} className="px-3 py-2 rounded-lg bg-amber-700/70 border border-amber-800">üßπ Clear today</button>
              </div>
            </div>

            <div className="mt-3 overflow-auto rounded-xl border border-line">
              <table className="min-w-[860px] w-full text-sm">
                <thead className="bg-slate-800/60 sticky top-0">
                  <tr className="[&>th]:px-3 [&>th]:py-2 border-b border-line text-zinc-200">
                    <th className="w-28 text-left">Time</th>
                    <th className="w-20 text-left">Session</th>
                    <th className="w-20 text-left">Vault</th>
                    <th className="w-36 text-left">Product ID</th>
                    <th className="text-left">Name</th>
                    <th className="w-28 text-right">Tare (g)</th>
                    <th className="w-28 text-right">Gross (g)</th>
                    <th className="w-28 text-right">Net (g)</th>
                    <th className="w-32 text-right">Variance (g)</th>
                    <th className="text-left">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {todayRows.map((e, idx) => {
                    const dt = new Date(e.ts);
                    const time = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
                    const warn = Math.abs(e.variance ?? 0) >= Number(settings.varianceThreshold || 5);
                    return (
                      <tr key={idx} className="border-b border-line hover:bg-slate-800/40">
                        <td className="px-3 py-2">{time}</td>
                        <td className="px-3 py-2">
                          <span className={`px-2 py-0.5 rounded-full text-xs border ${e.session==='AM' ? 'bg-blue-950/60 border-blue-900 text-blue-300' : 'bg-green-950/60 border-green-900 text-green-300'}`}>{e.session}</span>
                        </td>
                        <td className="px-3 py-2">{e.vault}</td>
                        <td className="px-3 py-2">{e.productId}</td>
                        <td className="px-3 py-2">{e.name}</td>
                        <td className="px-3 py-2 text-right tabular-nums">{fmt2(e.tare)}</td>
                        <td className="px-3 py-2 text-right tabular-nums">{fmt2(e.gross)}</td>
                        <td className="px-3 py-2 text-right tabular-nums">{fmt2(e.net)}</td>
                        <td className="px-3 py-2 text-right">
                          {e.variance === null || Number.isNaN(e.variance) ? '' :
                            <span className={`px-2 py-0.5 rounded-full text-xs border tabular-nums ${warn ? 'bg-rose-900/60 border-rose-800 text-rose-200' : 'bg-slate-800/60 border-line text-zinc-200'}`}>{fmt2(e.variance)}</span>}
                        </td>
                        <td className="px-3 py-2">{e.notes}</td>
                      </tr>
                    )
                  })}
                  {!todayRows.length && (
                    <tr><td className="px-3 py-6 text-center text-zinc-400" colSpan={10}>No entries for {date}.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </Panel>

          {/* Toast */}
          {!!msg && (
            <div className="fixed left-1/2 -translate-x-1/2 bottom-6 bg-slate-900 border border-line px-4 py-2 rounded-xl shadow-panel text-sm">
              {msg}
            </div>
          )}
        </div>
      );
    }

    // ---------- Reusable UI ----------
    function Panel({ title, children, className='' }){
      return (
        <section className={`bg-panel/80 border border-line rounded-xl2 shadow-panel p-4 ${className}`}>
          <h2 className="text-sm tracking-wider text-blue-100 mb-2">{title}</h2>
          {children}
        </section>
      );
    }
    function KPI({ label, value }){
      return (
        <div className="bg-slate-900/60 border border-line rounded-xl p-3">
          <div className="text-xs text-zinc-400">{label}</div>
          <div className="text-xl font-semibold mt-1 tabular-nums">{value}</div>
        </div>
      );
    }
    function Input({ label, value, onChange, placeholder='', type='text', step, disabled, refEl }){
      return (
        <label className="block">
          <span className="text-xs text-zinc-400">{label}</span>
          <input
            ref={refEl}
            className={`mt-1 w-full rounded-lg border border-line bg-slate-950/70 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 ${disabled?'opacity-70':''}`}
            value={value}
            type={type}
            step={step}
            placeholder={placeholder}
            disabled={disabled}
            onChange={e => onChange(e.target.value)}
          />
        </label>
      );
    }
    function Select({ label, value, onChange, options=[] }){
      return (
        <label className="block">
          <span className="text-xs text-zinc-400">{label}</span>
          <select
            className="mt-1 w-full rounded-lg border border-line bg-slate-950/70 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"
            value={value}
            onChange={e => onChange(e.target.value)}
          >
            {options.map(([v,l]) => <option key={v} value={v}>{l}</option>)}
          </select>
        </label>
      );
    }

    function RegistryPanel({ registry, saveProduct, deleteProduct, loadDemo, exportRegistry, prefillId }){
      const [id, setId] = useState('');
      const [name, setName] = useState('');
      const [tare, setTare] = useState('');

      useEffect(() => {
        if (!prefillId) return;
        // If Product ID exists, prefill its values for quick update
        const rec = registry[prefillId];
        if (rec) { setId(prefillId); setName(rec.name || ''); setTare(String(rec.tare ?? '')); }
        else { setId(prefillId); }
      }, [prefillId, registry]);

      return (
        <Panel title="Product registry (Product ID ‚Üí Tare & Name)">
          <div className="grid md:grid-cols-3 gap-3">
            <Input label="Product ID" value={id} onChange={setId} placeholder="e.g. STR-GLW-3.5" />
            <Input label="Name" value={name} onChange={setName} placeholder="Strain or SKU name" />
            <Input label="Tare (g)" type="number" step="0.01" value={tare} onChange={setTare} placeholder="Empty vault weight" />
          </div>
          <div className="flex flex-wrap gap-2 mt-3">
            <button onClick={() => saveProduct(id.trim(), name.trim(), tare)} className="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 font-semibold shadow-panel">üíæ Save / Update</button>
            <button onClick={() => deleteProduct(id.trim())} className="px-3 py-2 rounded-lg border border-line">üóëÔ∏è Delete</button>
            <button onClick={loadDemo} className="px-3 py-2 rounded-lg border border-line">üì• Load demo data</button>
            <button onClick={exportRegistry} className="px-3 py-2 rounded-lg border border-line">‚¨áÔ∏è Export registry CSV</button>
          </div>
          <p className="text-xs text-zinc-400 mt-2">Tare is tied to the Product ID. Only update tare if the container changes.</p>
          {/* Compact list */}
          <div className="mt-3 max-h-52 overflow-auto rounded-lg border border-line">
            <table className="w-full text-sm">
              <thead className="bg-slate-800/60 sticky top-0">
                <tr className="[&>th]:px-3 [&>th]:py-2 border-b border-line text-zinc-200">
                  <th className="w-40 text-left">Product ID</th>
                  <th className="text-left">Name</th>
                  <th className="w-28 text-right">Tare (g)</th>
                </tr>
              </thead>
              <tbody>
                {Object.keys(registry).length === 0 && (
                  <tr><td colSpan="3" className="px-3 py-3 text-zinc-400 text-center">No products yet.</td></tr>
                )}
                {Object.entries(registry).map(([pid, rec]) => (
                  <tr key={pid} className="border-b border-line hover:bg-slate-800/40">
                    <td className="px-3 py-1.5">{pid}</td>
                    <td className="px-3 py-1.5">{rec.name}</td>
                    <td className="px-3 py-1.5 text-right tabular-nums">{fmt2(rec.tare)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Panel>
      );
    }

    function Settings({ settings, setSettings }){
      const [open, setOpen] = useState(false);
      const [thr, setThr] = useState(settings.varianceThreshold);
      const [store, setStore] = useState(settings.storeName);

      useEffect(() => { setThr(settings.varianceThreshold); setStore(settings.storeName); }, [settings]);

      return (
        <>
          <button onClick={() => setOpen(true)} className="px-3 py-2 rounded-lg border border-line">‚öôÔ∏è Settings</button>
          {open && (
            <div className="fixed inset-0 z-20 grid place-items-center bg-black/60">
              <div className="bg-panel/90 border border-line rounded-xl2 p-4 w-[min(680px,92vw)] shadow-panel">
                <h3 className="text-lg font-semibold mb-3">Settings</h3>
                <div className="grid md:grid-cols-2 gap-3">
                  <Input label="Variance threshold (g)" type="number" step="0.01" value={thr} onChange={setThr} />
                  <Input label="Store / Location (optional)" value={store} onChange={setStore} placeholder="e.g. Verts ‚Äì Arlington" />
                </div>
                <div className="flex gap-2 mt-4">
                  <button
                    onClick={() => { setSettings({ varianceThreshold: isFinite(parseFloat(thr)) ? parseFloat(thr) : 5, storeName: store.trim() }); setOpen(false); }}
                    className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold shadow-panel"
                  >Save</button>
                  <button onClick={() => setOpen(false)} className="px-4 py-2 rounded-lg border border-line">Cancel</button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    // ---------- Mount ----------
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
